<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <title>Homework 3.2</title>
</head>
<body onload="loadPage()">

<main role="main" class="container">
    <div class="jumbotron">
        <h1>Homework 3.2</h1>
        <p class="lead">Select post id to load it</p>
            <div class="form-group">
                <label for="postIdInput">Enter post id</label>
                <input type="number" class="form-control" id="postIdInput" placeholder="Post id">
            </div>
            <button class="btn btn-lg btn-primary mt-3" onclick="getMessage()" >Load</button>
        <button class="btn btn-lg btn-secondary mt-3" onclick="clearMessages()" >Clear</button>
    </div>

    <div class="list-group mt-3" id="messagesList">
    </div>

</main>


<script>
    const DATABASE_NAME = 'homework3db';
    const DATABASE_VERSION = 2;
    const STORAGE_NAME = 'posts';

    async function loadPage() {
        const posts = await getAllPostsFromDatabase();
        if (posts) {
            const divElement = document.getElementById("messagesList");
            posts.forEach((post) => {
                const aElement = generatePostElement(post)
                divElement.prepend(aElement);
            })
        }
    }

    async function getMessage() {
        const postId = document.getElementById('postIdInput').value
        let newPost = await getPostFromDatabase(postId).then()
        console.log(newPost)
        if (!newPost) {
            newPost = await getPost(postId);
            newPost.postId = newPost.id;
            if (newPost.body) await addPostToDatabase(newPost);
            const divElement = document.getElementById("messagesList");
            const aElement = generatePostElement(newPost)
            divElement.prepend(aElement);
        } else {
            const container = document.querySelector('#messagesList');
            const messages = document.querySelectorAll('#messagesList a');
            for (const message of messages) {
                if (message.textContent.includes(`${newPost.postId}. ${newPost.title}`)) {
                    container.removeChild(message)
                    container.prepend(message)
                    break
                }
            }

        }
    }

    async function clearMessages() {
        function removeAllChildNodes(parent) {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }
        const container = document.querySelector('#messagesList');
        removeAllChildNodes(container);
        deleteDatabase();
    }


    function generatePostElement(post) {
        const h5Element = document.createElement("h5");
        h5Element.appendChild(document.createTextNode(`${post.postId}. ${post.title}`));
        const divElement = document.createElement("div");
        divElement.appendChild(h5Element);
        const pElement = document.createElement("p");
        pElement.className = "mb-1";
        pElement.appendChild(document.createTextNode(post.body));
        const aElement = document.createElement("a");
        aElement.className = "list-group-item list-group-item-action";
        aElement.appendChild(divElement);
        aElement.appendChild(pElement);
        return aElement;
    }

    async function getPost(id)
    {
        const url = `https://jsonplaceholder.typicode.com/posts/${id}`
        let response = await fetch(url);
        return await response.json();
    }

    async function addPostToDatabase(postJson) {
        let openRequest = indexedDB.open(DATABASE_NAME, DATABASE_VERSION), db;

        openRequest.onerror = function () {
            console.error("Error", openRequest.error);
        };

        openRequest.onsuccess = () => {
            db = openRequest.result;

            let transaction = db.transaction(STORAGE_NAME, "readwrite");

            let posts = transaction.objectStore(STORAGE_NAME);
            let newPost = {
                postId: postJson.id,
                title: postJson.title,
                body: postJson.body
            };
            let request = posts.add(newPost);

            request.onsuccess = () => {
                console.log("Post added", request.result);
            };

            request.onerror = function() {
                console.log("Error", request.error);
            };

            transaction.oncomplete = () => {db.close()}
        };
    }

    async function getPostFromDatabase(id) {
        return new Promise((resolve,reject)=>{
            setTimeout(()=>{
        let post = undefined;
            let openRequest = indexedDB.open(DATABASE_NAME, DATABASE_VERSION);
            openRequest.onerror = function () {
                console.error("Error", openRequest.error);
            };

            openRequest.onupgradeneeded = () => {
                let db = openRequest.result;
                if (!db.objectStoreNames.contains(STORAGE_NAME)) {
                    db.createObjectStore(STORAGE_NAME, {keyPath: 'postId', autoIncrement: false});
                }
            }

            openRequest.onsuccess = async () => {
                let db = openRequest.result;
                if (!db.objectStoreNames.contains(STORAGE_NAME)) {
                    return undefined
                }
                let transaction = db.transaction(STORAGE_NAME, "readwrite");
                let posts = transaction.objectStore(STORAGE_NAME);
                const getRequest = posts.get(parseInt(id));

                getRequest.onsuccess = async () => {
                    post = getRequest.result;
                    resolve(post)
                }
            };
            }, 100);
        });
    }

    async function getAllPostsFromDatabase() {
        return new Promise((resolve,reject)=>{
            setTimeout(()=>{
                let posts = undefined;
                let openRequest = indexedDB.open(DATABASE_NAME, DATABASE_VERSION);
                openRequest.onerror = function () {
                    console.error("Error", openRequest.error);
                };

                openRequest.onupgradeneeded = () => {
                    let db = openRequest.result;
                    if (!db.objectStoreNames.contains(STORAGE_NAME)) {
                        db.createObjectStore(STORAGE_NAME, {keyPath: 'postId', autoIncrement: false});
                    }
                }

                openRequest.onsuccess = async () => {
                    let db = openRequest.result;
                    if (!db.objectStoreNames.contains(STORAGE_NAME)) {
                        return undefined
                    }
                    let transaction = db.transaction(STORAGE_NAME, "readwrite");
                    let posts = transaction.objectStore(STORAGE_NAME);
                    const getRequest = posts.getAll();

                    getRequest.onsuccess = async () => {
                        posts = getRequest.result;
                        resolve(posts)
                    }
                };
            }, 100);
        });
    }

    function deleteDatabase() {
        indexedDB.deleteDatabase(DATABASE_NAME);
    }


</script>

</body>
</html>